name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build all artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu,x86_64-unknown-linux-musl,aarch64-unknown-linux-musl,x86_64-pc-windows-gnu

      - name: Install cross-compilation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu musl-tools mingw-w64
          # Create a wrapper for aarch64-linux-gnu-gcc to use as linker
          echo '#!/bin/bash' | sudo tee /usr/local/bin/aarch64-linux-gnu-gcc-wrapper > /dev/null
          echo 'exec aarch64-linux-gnu-gcc "$@"' | sudo tee -a /usr/local/bin/aarch64-linux-gnu-gcc-wrapper > /dev/null
          sudo chmod +x /usr/local/bin/aarch64-linux-gnu-gcc-wrapper

      - name: Setup Cargo config for cross-compilation
        run: |
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << 'EOF'
          [target.aarch64-unknown-linux-gnu]
          linker = "aarch64-linux-gnu-gcc"

          [target.aarch64-unknown-linux-musl]
          linker = "aarch64-linux-gnu-gcc"

          [target.x86_64-pc-windows-gnu]
          linker = "x86_64-w64-mingw32-gcc"
          EOF

      - name: Build template - x86_64 Linux
        working-directory: runfiles-stub
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu
          mkdir -p ../artifacts
          cp target/x86_64-unknown-linux-gnu/release/runfiles-stub ../artifacts/runfiles-stub-x86_64-linux

      - name: Build template - aarch64 Linux
        working-directory: runfiles-stub
        run: |
          cargo build --release --target aarch64-unknown-linux-gnu
          mkdir -p ../artifacts
          cp target/aarch64-unknown-linux-gnu/release/runfiles-stub ../artifacts/runfiles-stub-aarch64-linux

      - name: Build template - x86_64 Windows
        working-directory: runfiles-stub
        run: |
          cargo build --release --target x86_64-pc-windows-gnu
          mkdir -p ../artifacts
          cp target/x86_64-pc-windows-gnu/release/runfiles-stub.exe ../artifacts/runfiles-stub-x86_64-windows.exe

      - name: Build finalizer - x86_64 Linux (musl)
        working-directory: finalize-stub
        run: |
          # Override parent cargo config
          mkdir -p .cargo
          echo '[target.x86_64-unknown-linux-musl]' > .cargo/config.toml
          echo 'rustflags = ["-C", "target-feature=+crt-static"]' >> .cargo/config.toml
          cargo build --release --target x86_64-unknown-linux-musl
          mkdir -p ../artifacts
          cp target/x86_64-unknown-linux-musl/release/finalize-stub ../artifacts/finalize-stub-x86_64-linux

      - name: Build finalizer - aarch64 Linux (musl)
        working-directory: finalize-stub
        run: |
          cargo build --release --target aarch64-unknown-linux-musl
          cp target/aarch64-unknown-linux-musl/release/finalize-stub ../artifacts/finalize-stub-aarch64-linux

      - name: Build finalizer - x86_64 Windows
        working-directory: finalize-stub
        run: |
          cargo build --release --target x86_64-pc-windows-gnu
          cp target/x86_64-pc-windows-gnu/release/finalize-stub.exe ../artifacts/finalize-stub-x86_64-windows.exe

      - name: List artifacts
        run: |
          ls -lh artifacts/
          file artifacts/*

      - name: Upload Linux/Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-linux-windows
          path: artifacts/
          retention-days: 7

  build-macos:
    name: Build macOS binaries
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Build template - x86_64 macOS
        working-directory: runfiles-stub
        run: |
          mkdir -p ../artifacts
          cargo build --release --target x86_64-apple-darwin
          cp target/x86_64-apple-darwin/release/runfiles-stub ../artifacts/runfiles-stub-x86_64-macos

      - name: Build template - aarch64 macOS (Apple Silicon)
        working-directory: runfiles-stub
        run: |
          cargo build --release --target aarch64-apple-darwin
          cp target/aarch64-apple-darwin/release/runfiles-stub ../artifacts/runfiles-stub-aarch64-macos

      - name: Build finalizer - x86_64 macOS
        working-directory: finalize-stub
        run: |
          mkdir -p artifacts
          cargo build --release --target x86_64-apple-darwin
          cp target/x86_64-apple-darwin/release/finalize-stub ../artifacts/finalize-stub-x86_64-macos

      - name: Build finalizer - aarch64 macOS (Apple Silicon)
        working-directory: finalize-stub
        run: |
          cargo build --release --target aarch64-apple-darwin
          cp target/aarch64-apple-darwin/release/finalize-stub ../artifacts/finalize-stub-aarch64-macos

      - name: List artifacts
        run: |
          ls -lh artifacts/
          file artifacts/*

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-macos
          path: artifacts/
          retention-days: 7

  merge-artifacts:
    name: Merge all artifacts
    needs: [build, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux/Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries-linux-windows
          path: ./all-binaries

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries-macos
          path: ./all-binaries

      - name: List all binaries
        run: |
          ls -lh all-binaries/
          file all-binaries/* || true

      - name: Upload merged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: all-binaries/
          retention-days: 7

  test-linux:
    name: Test on Linux
    needs: merge-artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: ./binaries

      - name: Make binaries executable
        run: |
          chmod +x binaries/finalize-stub-x86_64-linux
          chmod +x binaries/runfiles-stub-x86_64-linux
          chmod +x binaries/runfiles-stub-aarch64-linux

      - name: Test finalizer on x86_64 template
        run: |
          echo "Testing finalizer with x86_64 template..."
          ./binaries/finalize-stub-x86_64-linux \
            --template binaries/runfiles-stub-x86_64-linux \
            --transform 0 \
            --output test-stub-x86_64 \
            -- \
            /bin/echo "Hello from x86_64"
          sha256sum test-stub-x86_64
          echo "SHA256 (x86_64 stub): $(sha256sum test-stub-x86_64 | cut -d' ' -f1)"

      - name: Test finalizer on aarch64 template
        run: |
          echo "Testing finalizer with aarch64 template..."
          ./binaries/finalize-stub-x86_64-linux \
            --template binaries/runfiles-stub-aarch64-linux \
            --transform 0 \
            --output test-stub-aarch64 \
            -- \
            /bin/echo "Hello from aarch64"
          sha256sum test-stub-aarch64
          echo "SHA256 (aarch64 stub): $(sha256sum test-stub-aarch64 | cut -d' ' -f1)"

      - name: Run x86_64 template (native)
        run: |
          echo "Running native x86_64 stub..."
          chmod +x test-stub-x86_64
          # Create a test manifest
          mkdir -p /tmp/runfiles
          cp /bin/echo /tmp/runfiles/echo
          export RUNFILES_DIR=/tmp/runfiles
          ./test-stub-x86_64 || echo "Exit code: $?"

      - name: Verify template is actually calling echo
        run: |
          echo "Creating proper manifest..."
          cat > manifest.txt << 'EOF'
          /bin/echo /bin/echo
          EOF
          RUNFILES_MANIFEST_FILE=manifest.txt ./test-stub-x86_64

      - name: Trace syscalls with strace (x86_64)
        run: |
          echo "Running x86_64 stub under strace to validate execve syscall..."
          cat > manifest.txt << 'EOF'
          /bin/echo /bin/echo
          EOF
          echo "Filtered execve output:"
          RUNFILES_MANIFEST_FILE=manifest.txt strace -f -e trace=execve ./test-stub-x86_64 2>&1 | grep execve || true
          echo ""
          echo "Full strace output for verification:"
          RUNFILES_MANIFEST_FILE=manifest.txt strace -f ./test-stub-x86_64 2>&1 | head -50

      - name: Test environment variable export (enabled)
        run: |
          echo "=== Testing Environment Variable Export (enabled) ==="

          # Create a script that prints runfiles environment variables
          cat > /tmp/print-env.sh << 'EOF'
          #!/bin/bash
          echo "RUNFILES_DIR=${RUNFILES_DIR}"
          echo "RUNFILES_MANIFEST_FILE=${RUNFILES_MANIFEST_FILE}"
          echo "JAVA_RUNFILES=${JAVA_RUNFILES}"
          EOF
          chmod +x /tmp/print-env.sh

          # Create stub with export enabled (default)
          ./binaries/finalize-stub-x86_64-linux \
            --template binaries/runfiles-stub-x86_64-linux \
            --transform 0 \
            --export-runfiles-env true \
            --output test-export-enabled \
            -- \
            /tmp/print-env.sh
          chmod +x test-export-enabled

          # Test with manifest-based runfiles
          echo ""
          echo "Test 1: Manifest-based mode"
          cat > test-manifest.txt << 'EOF'
          /tmp/print-env.sh /tmp/print-env.sh
          EOF
          echo "Output from child process:"
          RUNFILES_MANIFEST_FILE=test-manifest.txt ./test-export-enabled > export-test-manifest.txt
          cat export-test-manifest.txt

          # Verify RUNFILES_MANIFEST_FILE is exported
          if grep -q "RUNFILES_MANIFEST_FILE=test-manifest.txt" export-test-manifest.txt; then
            echo "✓ RUNFILES_MANIFEST_FILE correctly exported"
          else
            echo "✗ ERROR: RUNFILES_MANIFEST_FILE not exported"
            exit 1
          fi

          # Test with directory-based fallback
          echo ""
          echo "Test 2: Directory-based fallback mode"
          mkdir -p test-export-enabled.runfiles
          echo "Output from child process:"
          env -i ./test-export-enabled > export-test-fallback.txt
          cat export-test-fallback.txt

          # Verify RUNFILES_DIR is exported with fallback directory
          if grep -q "RUNFILES_DIR=.*test-export-enabled.runfiles" export-test-fallback.txt; then
            echo "✓ RUNFILES_DIR correctly exported (fallback)"
          else
            echo "✗ ERROR: RUNFILES_DIR not exported in fallback mode"
            cat export-test-fallback.txt
            exit 1
          fi

          # Verify JAVA_RUNFILES is also exported
          if grep -q "JAVA_RUNFILES=.*test-export-enabled.runfiles" export-test-fallback.txt; then
            echo "✓ JAVA_RUNFILES correctly exported"
          else
            echo "✗ ERROR: JAVA_RUNFILES not exported"
            exit 1
          fi

      - name: Test environment variable export (disabled)
        run: |
          echo "=== Testing Environment Variable Export (disabled) ==="

          # Create stub with export disabled
          ./binaries/finalize-stub-x86_64-linux \
            --template binaries/runfiles-stub-x86_64-linux \
            --transform 0 \
            --export-runfiles-env false \
            --output test-export-disabled \
            -- \
            /tmp/print-env.sh
          chmod +x test-export-disabled

          # Test with empty environment and fallback directory
          mkdir -p test-export-disabled.runfiles
          echo "Output from child process (export disabled):"
          env -i ./test-export-disabled > export-test-disabled.txt
          cat export-test-disabled.txt

          # Verify environment variables are NOT exported
          if grep -q "RUNFILES_DIR=$" export-test-disabled.txt && \
             grep -q "RUNFILES_MANIFEST_FILE=$" export-test-disabled.txt && \
             grep -q "JAVA_RUNFILES=$" export-test-disabled.txt; then
            echo "✓ Environment variables correctly NOT exported"
          else
            echo "✗ ERROR: Environment variables were exported when they should not be"
            cat export-test-disabled.txt
            exit 1
          fi

          echo ""
          echo "✓ All environment export tests passed!"

      - name: Cross-platform finalization test - finalize all templates
        run: |
          echo "=== Cross-platform Finalization Test ==="
          echo "Finalizing all templates with Linux finalizer to verify deterministic output"
          echo ""

          # Finalize all available templates with the same arguments
          mkdir -p cross-platform-test

          echo "Finalizing Linux x86_64 template..."
          ./binaries/finalize-stub-x86_64-linux \
            --template binaries/runfiles-stub-x86_64-linux \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-x86_64-linux \
            -- \
            /bin/echo "test arg"

          echo "Finalizing Linux aarch64 template..."
          ./binaries/finalize-stub-x86_64-linux \
            --template binaries/runfiles-stub-aarch64-linux \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-aarch64-linux \
            -- \
            /bin/echo "test arg"

          echo "Finalizing macOS x86_64 template..."
          ./binaries/finalize-stub-x86_64-linux \
            --template binaries/runfiles-stub-x86_64-macos \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-x86_64-macos \
            -- \
            /bin/echo "test arg"

          echo "Finalizing macOS aarch64 template..."
          ./binaries/finalize-stub-x86_64-linux \
            --template binaries/runfiles-stub-aarch64-macos \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-aarch64-macos \
            -- \
            /bin/echo "test arg"

          echo "Finalizing Windows x86_64 template..."
          ./binaries/finalize-stub-x86_64-linux \
            --template binaries/runfiles-stub-x86_64-windows.exe \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-x86_64-windows.exe \
            -- \
            'C:\Windows\System32\cmd.exe' "test arg"

          echo ""
          echo "Computing SHA256 hashes..."
          sha256sum cross-platform-test/finalized-* | tee cross-platform-test/sha256sums-linux.txt

          echo ""
          echo "SHA256 hashes computed on Linux:"
          cat cross-platform-test/sha256sums-linux.txt

      - name: Upload cross-platform test results (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: cross-platform-hashes-linux
          path: cross-platform-test/sha256sums-linux.txt
          retention-days: 7

      - name: Upload finalized binaries (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: finalized-binaries-linux
          path: cross-platform-test/finalized-*
          retention-days: 7

  test-macos:
    name: Test on macOS
    needs: merge-artifacts
    runs-on: macos-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: ./binaries

      - name: Detect architecture
        id: arch
        run: |
          ARCH=$(uname -m)
          echo "arch=$ARCH" >> $GITHUB_OUTPUT
          echo "Detected architecture: $ARCH"

      - name: Make binaries executable
        run: |
          if [ "${{ steps.arch.outputs.arch }}" = "arm64" ]; then
            chmod +x binaries/finalize-stub-aarch64-macos
            chmod +x binaries/runfiles-stub-aarch64-macos
          else
            chmod +x binaries/finalize-stub-x86_64-macos
            chmod +x binaries/runfiles-stub-x86_64-macos
          fi

      - name: Test finalizer on macOS template
        run: |
          if [ "${{ steps.arch.outputs.arch }}" = "arm64" ]; then
            FINALIZER="binaries/finalize-stub-aarch64-macos"
            TEMPLATE="binaries/runfiles-stub-aarch64-macos"
            ARCH_NAME="aarch64"
          else
            FINALIZER="binaries/finalize-stub-x86_64-macos"
            TEMPLATE="binaries/runfiles-stub-x86_64-macos"
            ARCH_NAME="x86_64"
          fi

          echo "Testing finalizer with macOS $ARCH_NAME template..."
          $FINALIZER \
            --template $TEMPLATE \
            --transform 0 \
            --output test-stub-macos \
            -- \
            /bin/echo "Hello from macOS $ARCH_NAME"
          shasum -a 256 test-stub-macos
          echo "SHA256 (macOS stub): $(shasum -a 256 test-stub-macos | cut -d' ' -f1)"

      - name: Run macOS template (native)
        run: |
          echo "Running native macOS stub..."
          chmod +x test-stub-macos
          # Create a test manifest
          mkdir -p /tmp/runfiles
          cp /bin/echo /tmp/runfiles/echo
          export RUNFILES_DIR=/tmp/runfiles
          ./test-stub-macos || echo "Exit code: $?"

      - name: Verify template is actually calling echo
        run: |
          echo "Creating proper manifest..."
          cat > manifest.txt << 'EOF'
          /bin/echo /bin/echo
          EOF
          RUNFILES_MANIFEST_FILE=manifest.txt ./test-stub-macos

      - name: Test environment variable export (enabled)
        run: |
          if [ "${{ steps.arch.outputs.arch }}" = "arm64" ]; then
            FINALIZER="binaries/finalize-stub-aarch64-macos"
            TEMPLATE="binaries/runfiles-stub-aarch64-macos"
          else
            FINALIZER="binaries/finalize-stub-x86_64-macos"
            TEMPLATE="binaries/runfiles-stub-x86_64-macos"
          fi

          echo "=== Testing Environment Variable Export (enabled) ==="

          # Create a script that prints runfiles environment variables
          cat > /tmp/print-env.sh << 'EOF'
          #!/bin/bash
          echo "RUNFILES_DIR=${RUNFILES_DIR}"
          echo "RUNFILES_MANIFEST_FILE=${RUNFILES_MANIFEST_FILE}"
          echo "JAVA_RUNFILES=${JAVA_RUNFILES}"
          EOF
          chmod +x /tmp/print-env.sh

          # Create stub with export enabled (default)
          $FINALIZER \
            --template $TEMPLATE \
            --transform 0 \
            --export-runfiles-env true \
            --output test-export-enabled \
            -- \
            /tmp/print-env.sh
          chmod +x test-export-enabled

          # Test with manifest-based runfiles
          echo ""
          echo "Test 1: Manifest-based mode"
          cat > test-manifest.txt << 'EOF'
          /tmp/print-env.sh /tmp/print-env.sh
          EOF
          echo "Output from child process:"
          RUNFILES_MANIFEST_FILE=test-manifest.txt ./test-export-enabled > export-test-manifest.txt
          cat export-test-manifest.txt

          # Verify RUNFILES_MANIFEST_FILE is exported
          if grep -q "RUNFILES_MANIFEST_FILE=test-manifest.txt" export-test-manifest.txt; then
            echo "✓ RUNFILES_MANIFEST_FILE correctly exported"
          else
            echo "✗ ERROR: RUNFILES_MANIFEST_FILE not exported"
            exit 1
          fi

          # Test with directory-based fallback
          echo ""
          echo "Test 2: Directory-based fallback mode"
          mkdir -p test-export-enabled.runfiles
          echo "Output from child process:"
          env -i ./test-export-enabled > export-test-fallback.txt
          cat export-test-fallback.txt

          # Verify RUNFILES_DIR is exported with fallback directory
          if grep -q "RUNFILES_DIR=.*test-export-enabled.runfiles" export-test-fallback.txt; then
            echo "✓ RUNFILES_DIR correctly exported (fallback)"
          else
            echo "✗ ERROR: RUNFILES_DIR not exported in fallback mode"
            cat export-test-fallback.txt
            exit 1
          fi

          # Verify JAVA_RUNFILES is also exported
          if grep -q "JAVA_RUNFILES=.*test-export-enabled.runfiles" export-test-fallback.txt; then
            echo "✓ JAVA_RUNFILES correctly exported"
          else
            echo "✗ ERROR: JAVA_RUNFILES not exported"
            exit 1
          fi

      - name: Test environment variable export (disabled)
        run: |
          if [ "${{ steps.arch.outputs.arch }}" = "arm64" ]; then
            FINALIZER="binaries/finalize-stub-aarch64-macos"
            TEMPLATE="binaries/runfiles-stub-aarch64-macos"
          else
            FINALIZER="binaries/finalize-stub-x86_64-macos"
            TEMPLATE="binaries/runfiles-stub-x86_64-macos"
          fi

          echo "=== Testing Environment Variable Export (disabled) ==="

          # Create stub with export disabled
          $FINALIZER \
            --template $TEMPLATE \
            --transform 0 \
            --export-runfiles-env false \
            --output test-export-disabled \
            -- \
            /tmp/print-env.sh
          chmod +x test-export-disabled

          # Test with empty environment and fallback directory
          mkdir -p test-export-disabled.runfiles
          echo "Output from child process (export disabled):"
          env -i ./test-export-disabled > export-test-disabled.txt
          cat export-test-disabled.txt

          # Verify environment variables are NOT exported
          if grep -q "RUNFILES_DIR=$" export-test-disabled.txt && \
             grep -q "RUNFILES_MANIFEST_FILE=$" export-test-disabled.txt && \
             grep -q "JAVA_RUNFILES=$" export-test-disabled.txt; then
            echo "✓ Environment variables correctly NOT exported"
          else
            echo "✗ ERROR: Environment variables were exported when they should not be"
            cat export-test-disabled.txt
            exit 1
          fi

          echo ""
          echo "✓ All environment export tests passed!"

      - name: Test finalizer with Linux templates (cross-platform)
        run: |
          if [ "${{ steps.arch.outputs.arch }}" = "arm64" ]; then
            FINALIZER="binaries/finalize-stub-aarch64-macos"
          else
            FINALIZER="binaries/finalize-stub-x86_64-macos"
          fi

          echo "Testing finalizer with Linux x86_64 template..."
          $FINALIZER \
            --template binaries/runfiles-stub-x86_64-linux \
            --transform 0 \
            --output test-stub-linux-x86_64 \
            -- \
            /bin/echo "Hello from Linux x86_64"
          shasum -a 256 test-stub-linux-x86_64

          echo "Testing finalizer with Linux aarch64 template..."
          $FINALIZER \
            --template binaries/runfiles-stub-aarch64-linux \
            --transform 0 \
            --output test-stub-linux-aarch64 \
            -- \
            /bin/echo "Hello from Linux aarch64"
          shasum -a 256 test-stub-linux-aarch64

      - name: Cross-platform finalization test - finalize all templates
        run: |
          if [ "${{ steps.arch.outputs.arch }}" = "arm64" ]; then
            FINALIZER="binaries/finalize-stub-aarch64-macos"
          else
            FINALIZER="binaries/finalize-stub-x86_64-macos"
          fi

          echo "=== Cross-platform Finalization Test ==="
          echo "Finalizing all templates with macOS finalizer to verify deterministic output"
          echo ""

          # Finalize all available templates with the same arguments
          mkdir -p cross-platform-test

          echo "Finalizing Linux x86_64 template..."
          $FINALIZER \
            --template binaries/runfiles-stub-x86_64-linux \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-x86_64-linux \
            -- \
            /bin/echo "test arg"

          echo "Finalizing Linux aarch64 template..."
          $FINALIZER \
            --template binaries/runfiles-stub-aarch64-linux \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-aarch64-linux \
            -- \
            /bin/echo "test arg"

          echo "Finalizing macOS x86_64 template..."
          $FINALIZER \
            --template binaries/runfiles-stub-x86_64-macos \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-x86_64-macos \
            -- \
            /bin/echo "test arg"

          echo "Finalizing macOS aarch64 template..."
          $FINALIZER \
            --template binaries/runfiles-stub-aarch64-macos \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-aarch64-macos \
            -- \
            /bin/echo "test arg"

          echo "Finalizing Windows x86_64 template..."
          $FINALIZER \
            --template binaries/runfiles-stub-x86_64-windows.exe \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-x86_64-windows.exe \
            -- \
            'C:\Windows\System32\cmd.exe' "test arg"

          echo ""
          echo "Computing SHA256 hashes..."
          shasum -a 256 cross-platform-test/finalized-* | tee cross-platform-test/sha256sums-macos.txt

          echo ""
          echo "SHA256 hashes computed on macOS:"
          cat cross-platform-test/sha256sums-macos.txt

      - name: Upload cross-platform test results (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: cross-platform-hashes-macos
          path: cross-platform-test/sha256sums-macos.txt
          retention-days: 7

      - name: Upload finalized binaries (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: finalized-binaries-macos
          path: cross-platform-test/finalized-*
          retention-days: 7

  test-windows:
    name: Test on Windows
    needs: merge-artifacts
    runs-on: windows-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: ./binaries

      - name: Test finalizer on Windows template
        shell: bash
        run: |
          echo "Testing finalizer with Windows x86_64 template..."
          ./binaries/finalize-stub-x86_64-windows.exe \
            --template binaries/runfiles-stub-x86_64-windows.exe \
            --transform 0 \
            --output test-stub-windows.exe \
            -- \
            'C:\Windows\System32\cmd.exe' '//C' 'echo Hello from Windows'
          sha256sum test-stub-windows.exe || certutil -hashfile test-stub-windows.exe SHA256
          echo "SHA256 (Windows stub): $(sha256sum test-stub-windows.exe 2>/dev/null | cut -d' ' -f1 || certutil -hashfile test-stub-windows.exe SHA256 | findstr -v 'SHA256' | findstr -v 'CertUtil')"

      - name: Check DLL dependencies
        shell: bash
        run: |
          echo "Checking DLL dependencies..."
          objdump -x test-stub-windows.exe | grep "DLL Name" || true
          ldd test-stub-windows.exe || true

      - name: Run Windows template with PowerShell
        shell: pwsh
        run: |
          Write-Host "Running native Windows stub with PowerShell..."
          Write-Host "Creating manifest..."
          @"
          C:\Windows\System32\cmd.exe C:\Windows\System32\cmd.exe
          "@ | Out-File -FilePath manifest.txt -Encoding ASCII

          Write-Host "Setting environment and running binary..."
          $env:RUNFILES_MANIFEST_FILE = "manifest.txt"
          try {
            .\test-stub-windows.exe
            Write-Host "Success! Exit code: $LASTEXITCODE"
          } catch {
            Write-Host "Error: $_"
            Write-Host "Exit code: $LASTEXITCODE"
          }

      - name: Run Windows template (native)
        shell: bash
        run: |
          echo "Running native Windows stub..."
          chmod +x test-stub-windows.exe
          # Create a test manifest
          mkdir -p /tmp/runfiles || true
          cat > manifest.txt << 'EOF'
          C:\Windows\System32\cmd.exe C:\Windows\System32\cmd.exe
          EOF
          echo "Checking if binary exists and is executable..."
          ls -lh test-stub-windows.exe
          file test-stub-windows.exe || true
          echo "Attempting to run binary..."
          RUNFILES_MANIFEST_FILE=manifest.txt ./test-stub-windows.exe || echo "Exit code: $?"

      - name: Verify template is actually calling cmd
        shell: bash
        run: |
          echo "Creating proper manifest..."
          cat > manifest.txt << 'EOF'
          C:\Windows\System32\cmd.exe C:\Windows\System32\cmd.exe
          EOF
          echo "Debug: Manifest contents:"
          cat manifest.txt
          echo ""
          echo "Debug: Trying to run with full path..."
          RUNFILES_MANIFEST_FILE=manifest.txt "$(pwd)/test-stub-windows.exe" || {
            echo "Failed with exit code: $?"
            echo "Debug: Trying with cmd.exe wrapper..."
            cmd.exe //C "set RUNFILES_MANIFEST_FILE=manifest.txt && test-stub-windows.exe"
          }

      - name: Test environment variable export (enabled)
        shell: bash
        run: |
          echo "=== Testing Environment Variable Export (enabled) ==="

          # Create a batch script that prints runfiles environment variables
          cat > /tmp/print-env.bat << 'EOF'
          @echo off
          echo RUNFILES_DIR=%RUNFILES_DIR%
          echo RUNFILES_MANIFEST_FILE=%RUNFILES_MANIFEST_FILE%
          echo JAVA_RUNFILES=%JAVA_RUNFILES%
          EOF
          chmod +x /tmp/print-env.bat

          # Create stub with export enabled (default)
          ./binaries/finalize-stub-x86_64-windows.exe \
            --template binaries/runfiles-stub-x86_64-windows.exe \
            --transform 0 \
            --export-runfiles-env true \
            --output test-export-enabled.exe \
            -- \
            /tmp/print-env.bat
          chmod +x test-export-enabled.exe

          # Test with manifest-based runfiles
          echo ""
          echo "Test 1: Manifest-based mode"
          cat > test-manifest.txt << 'EOF'
          /tmp/print-env.bat /tmp/print-env.bat
          EOF
          echo "Output from child process:"
          RUNFILES_MANIFEST_FILE=test-manifest.txt ./test-export-enabled.exe > export-test-manifest.txt
          cat export-test-manifest.txt

          # Verify RUNFILES_MANIFEST_FILE is exported
          if grep -q "RUNFILES_MANIFEST_FILE=test-manifest.txt" export-test-manifest.txt; then
            echo "✓ RUNFILES_MANIFEST_FILE correctly exported"
          else
            echo "✗ ERROR: RUNFILES_MANIFEST_FILE not exported"
            cat export-test-manifest.txt
            exit 1
          fi

          # Test with directory-based fallback
          echo ""
          echo "Test 2: Directory-based fallback mode"
          mkdir -p test-export-enabled.exe.runfiles
          echo "Output from child process:"
          env -i ./test-export-enabled.exe > export-test-fallback.txt
          cat export-test-fallback.txt

          # Verify RUNFILES_DIR is exported with fallback directory (Windows paths may vary)
          if grep -q "RUNFILES_DIR=" export-test-fallback.txt && grep "RUNFILES_DIR=" export-test-fallback.txt | grep -v "RUNFILES_DIR=$"; then
            echo "✓ RUNFILES_DIR correctly exported (fallback)"
          else
            echo "✗ ERROR: RUNFILES_DIR not exported in fallback mode"
            cat export-test-fallback.txt
            exit 1
          fi

          # Verify JAVA_RUNFILES is also exported
          if grep -q "JAVA_RUNFILES=" export-test-fallback.txt && grep "JAVA_RUNFILES=" export-test-fallback.txt | grep -v "JAVA_RUNFILES=$"; then
            echo "✓ JAVA_RUNFILES correctly exported"
          else
            echo "✗ ERROR: JAVA_RUNFILES not exported"
            exit 1
          fi

      - name: Test environment variable export (disabled)
        shell: bash
        run: |
          echo "=== Testing Environment Variable Export (disabled) ==="

          # Create stub with export disabled
          ./binaries/finalize-stub-x86_64-windows.exe \
            --template binaries/runfiles-stub-x86_64-windows.exe \
            --transform 0 \
            --export-runfiles-env false \
            --output test-export-disabled.exe \
            -- \
            /tmp/print-env.bat
          chmod +x test-export-disabled.exe

          # Test with empty environment and fallback directory
          mkdir -p test-export-disabled.exe.runfiles
          echo "Output from child process (export disabled):"
          env -i ./test-export-disabled.exe > export-test-disabled.txt
          cat export-test-disabled.txt

          # Verify environment variables are NOT exported (Windows batch shows undefined as %VAR%)
          if (grep -q "RUNFILES_DIR=$" export-test-disabled.txt || grep -q "RUNFILES_DIR=%RUNFILES_DIR%" export-test-disabled.txt) && \
             (grep -q "RUNFILES_MANIFEST_FILE=$" export-test-disabled.txt || grep -q "RUNFILES_MANIFEST_FILE=%RUNFILES_MANIFEST_FILE%" export-test-disabled.txt) && \
             (grep -q "JAVA_RUNFILES=$" export-test-disabled.txt || grep -q "JAVA_RUNFILES=%JAVA_RUNFILES%" export-test-disabled.txt); then
            echo "✓ Environment variables correctly NOT exported"
          else
            echo "✗ ERROR: Environment variables were exported when they should not be"
            cat export-test-disabled.txt
            exit 1
          fi

          echo ""
          echo "✓ All environment export tests passed!"

      - name: Test runtime arguments
        shell: bash
        run: |
          echo "Testing runtime arguments support..."

          # Create a batch script that prints its arguments
          cat > print-args.bat << 'EOF'
          @echo off
          echo ARG0=%0
          echo ARG1=%1
          echo ARG2=%2
          echo ARG3=%3
          EOF

          # Create finalized stub that runs the batch script
          ./binaries/finalize-stub-x86_64-windows.exe \
            --template binaries/runfiles-stub-x86_64-windows.exe \
            --transform 0 \
            --output test-runtime-args.exe \
            -- \
            C:\\Windows\\System32\\cmd.exe //C print-args.bat

          # Create manifest
          cat > manifest.txt << 'EOF'
          C:\Windows\System32\cmd.exe C:\Windows\System32\cmd.exe
          EOF

          chmod +x test-runtime-args.exe

          # Test 1: No runtime arguments
          echo ""
          echo "Test 1: No runtime arguments"
          RUNFILES_MANIFEST_FILE=manifest.txt ./test-runtime-args.exe > args-test1.txt
          cat args-test1.txt
          if grep -q "ARG0=print-args.bat" args-test1.txt && \
             (grep -q "ARG1=$" args-test1.txt || grep -q "ARG1=%1" args-test1.txt); then
            echo "✓ No runtime arguments test passed"
          else
            echo "✗ ERROR: Unexpected output without runtime arguments"
            exit 1
          fi

          # Test 2: Single runtime argument
          echo ""
          echo "Test 2: Single runtime argument"
          RUNFILES_MANIFEST_FILE=manifest.txt ./test-runtime-args.exe hello > args-test2.txt
          cat args-test2.txt
          if grep -q "ARG0=print-args.bat" args-test2.txt && grep -q "ARG1=hello" args-test2.txt; then
            echo "✓ Single runtime argument test passed"
          else
            echo "✗ ERROR: Runtime argument not passed correctly"
            exit 1
          fi

          # Test 3: Multiple runtime arguments
          echo ""
          echo "Test 3: Multiple runtime arguments"
          RUNFILES_MANIFEST_FILE=manifest.txt ./test-runtime-args.exe arg1 arg2 arg3 > args-test3.txt
          cat args-test3.txt
          if grep -q "ARG0=print-args.bat" args-test3.txt && \
             grep -q "ARG1=arg1" args-test3.txt && \
             grep -q "ARG2=arg2" args-test3.txt && \
             grep -q "ARG3=arg3" args-test3.txt; then
            echo "✓ Multiple runtime arguments test passed"
          else
            echo "✗ ERROR: Multiple runtime arguments not passed correctly"
            exit 1
          fi

          # Test 4: Runtime argument with spaces (should be quoted)
          echo ""
          echo "Test 4: Runtime argument with spaces"
          RUNFILES_MANIFEST_FILE=manifest.txt ./test-runtime-args.exe "hello world" > args-test4.txt
          cat args-test4.txt
          # Windows batch preserves quotes, so we check for either quoted or unquoted
          if grep -q "ARG0=print-args.bat" args-test4.txt && (grep -q 'ARG1="hello world"' args-test4.txt || grep -q "ARG1=hello world" args-test4.txt); then
            echo "✓ Quoted runtime argument test passed"
          else
            echo "✗ ERROR: Quoted runtime argument not passed correctly"
            exit 1
          fi

          echo ""
          echo "✓ All runtime arguments tests passed!"

      - name: Cross-platform finalization test - finalize all templates
        shell: bash
        run: |
          # Disable MSYS path conversion to ensure deterministic behavior
          export MSYS_NO_PATHCONV=1
          export MSYS2_ARG_CONV_EXCL="*"

          echo "=== Cross-platform Finalization Test ==="
          echo "Finalizing all templates with Windows finalizer to verify deterministic output"
          echo ""

          # Finalize all available templates with the same arguments
          mkdir -p cross-platform-test

          echo "Finalizing Linux x86_64 template..."
          ./binaries/finalize-stub-x86_64-windows.exe \
            --template binaries/runfiles-stub-x86_64-linux \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-x86_64-linux \
            -- \
            /bin/echo "test arg"

          echo "Finalizing Linux aarch64 template..."
          ./binaries/finalize-stub-x86_64-windows.exe \
            --template binaries/runfiles-stub-aarch64-linux \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-aarch64-linux \
            -- \
            /bin/echo "test arg"

          echo "Finalizing macOS x86_64 template..."
          ./binaries/finalize-stub-x86_64-windows.exe \
            --template binaries/runfiles-stub-x86_64-macos \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-x86_64-macos \
            -- \
            /bin/echo "test arg"

          echo "Finalizing macOS aarch64 template..."
          ./binaries/finalize-stub-x86_64-windows.exe \
            --template binaries/runfiles-stub-aarch64-macos \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-aarch64-macos \
            -- \
            /bin/echo "test arg"

          echo "Finalizing Windows x86_64 template..."
          ./binaries/finalize-stub-x86_64-windows.exe \
            --template binaries/runfiles-stub-x86_64-windows.exe \
            --transform 0 \
            --transform 1 \
            --output cross-platform-test/finalized-x86_64-windows.exe \
            -- \
            'C:\Windows\System32\cmd.exe' "test arg"

          echo ""
          echo "Computing SHA256 hashes..."
          cd cross-platform-test
          sha256sum finalized-* 2>/dev/null | tee sha256sums-windows.txt || \
            (for f in finalized-*; do certutil -hashfile "$f" SHA256 | grep -v "SHA256" | grep -v "CertUtil" | tr -d '\r' | awk -v f="$f" '{print $1 "  " f}'; done | tee sha256sums-windows.txt)
          cd ..

          echo ""
          echo "SHA256 hashes computed on Windows:"
          cat cross-platform-test/sha256sums-windows.txt

      - name: Upload cross-platform test results (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: cross-platform-hashes-windows
          path: cross-platform-test/sha256sums-windows.txt
          retention-days: 7

      - name: Upload finalized binaries (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: finalized-binaries-windows
          path: cross-platform-test/finalized-*
          retention-days: 7

  verify-deterministic-finalization:
    name: Verify deterministic cross-platform finalization
    needs: [test-linux, test-macos, test-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux hashes
        uses: actions/download-artifact@v4
        with:
          name: cross-platform-hashes-linux
          path: ./hashes

      - name: Download macOS hashes
        uses: actions/download-artifact@v4
        with:
          name: cross-platform-hashes-macos
          path: ./hashes

      - name: Download Windows hashes
        uses: actions/download-artifact@v4
        with:
          name: cross-platform-hashes-windows
          path: ./hashes

      - name: Compare SHA256 hashes across platforms
        run: |
          echo "=== Verifying Deterministic Finalization ==="
          echo ""
          echo "This test verifies that the finalizer produces identical output"
          echo "regardless of which platform it runs on (Linux, macOS, or Windows)."
          echo ""

          echo "Linux SHA256 hashes:"
          cat hashes/sha256sums-linux.txt
          echo ""

          echo "macOS SHA256 hashes:"
          cat hashes/sha256sums-macos.txt
          echo ""

          echo "Windows SHA256 hashes:"
          cat hashes/sha256sums-windows.txt
          echo ""

          # Extract just the hashes (first column) and sort them
          echo "Extracting and sorting hashes for comparison..."
          cat hashes/sha256sums-linux.txt | awk '{print $1}' | sort > linux-hashes.txt
          cat hashes/sha256sums-macos.txt | awk '{print $1}' | sort > macos-hashes.txt
          cat hashes/sha256sums-windows.txt | awk '{print $1}' | sort > windows-hashes.txt

          echo "Comparing Linux vs macOS..."
          if diff linux-hashes.txt macos-hashes.txt; then
            echo "✓ Linux and macOS produce identical hashes"
          else
            echo "✗ ERROR: Linux and macOS produce different hashes!"
            echo "This means the finalizer is not deterministic across platforms."
            exit 1
          fi

          echo ""
          echo "Comparing Linux vs Windows..."
          if diff linux-hashes.txt windows-hashes.txt; then
            echo "✓ Linux and Windows produce identical hashes"
          else
            echo "✗ ERROR: Linux and Windows produce different hashes!"
            echo "This means the finalizer is not deterministic across platforms."
            exit 1
          fi

          echo ""
          echo "Comparing macOS vs Windows..."
          if diff macos-hashes.txt windows-hashes.txt; then
            echo "✓ macOS and Windows produce identical hashes"
          else
            echo "✗ ERROR: macOS and Windows produce different hashes!"
            echo "This means the finalizer is not deterministic across platforms."
            exit 1
          fi

          echo ""
          echo "========================================="
          echo "✓ SUCCESS: All platforms produce identical output!"
          echo "The finalizer is deterministic and platform-independent."
          echo "========================================="

  # Integration tests using the Rust test suite
  integration-test-linux:
    name: Integration tests (Linux)
    needs: merge-artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: ./binaries

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Make binaries executable
        run: |
          chmod +x binaries/finalize-stub-x86_64-linux
          chmod +x binaries/runfiles-stub-x86_64-linux

      - name: Build test suite
        working-directory: integration-tests
        run: cargo build --release

      - name: Run integration tests
        run: |
          ./integration-tests/target/release/test-runner \
            --template binaries/runfiles-stub-x86_64-linux \
            --finalizer binaries/finalize-stub-x86_64-linux \
            --test-binaries integration-tests/target/release \
            --work-dir /tmp/runfiles-stub-tests

  integration-test-macos:
    name: Integration tests (macOS)
    needs: merge-artifacts
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: ./binaries

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Detect architecture
        id: arch
        run: |
          ARCH=$(uname -m)
          echo "arch=$ARCH" >> $GITHUB_OUTPUT
          echo "Detected architecture: $ARCH"

      - name: Make binaries executable
        run: |
          if [ "${{ steps.arch.outputs.arch }}" = "arm64" ]; then
            chmod +x binaries/finalize-stub-aarch64-macos
            chmod +x binaries/runfiles-stub-aarch64-macos
          else
            chmod +x binaries/finalize-stub-x86_64-macos
            chmod +x binaries/runfiles-stub-x86_64-macos
          fi

      - name: Build test suite
        working-directory: integration-tests
        run: cargo build --release

      - name: Run integration tests
        run: |
          if [ "${{ steps.arch.outputs.arch }}" = "arm64" ]; then
            TEMPLATE="binaries/runfiles-stub-aarch64-macos"
            FINALIZER="binaries/finalize-stub-aarch64-macos"
          else
            TEMPLATE="binaries/runfiles-stub-x86_64-macos"
            FINALIZER="binaries/finalize-stub-x86_64-macos"
          fi

          ./integration-tests/target/release/test-runner \
            --template "$TEMPLATE" \
            --finalizer "$FINALIZER" \
            --test-binaries integration-tests/target/release \
            --work-dir /tmp/runfiles-stub-tests

  integration-test-windows:
    name: Integration tests (Windows)
    needs: merge-artifacts
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: ./binaries

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build test suite
        working-directory: integration-tests
        run: cargo build --release

      - name: Run integration tests
        shell: bash
        run: |
          ./integration-tests/target/release/test-runner.exe \
            --template binaries/runfiles-stub-x86_64-windows.exe \
            --finalizer binaries/finalize-stub-x86_64-windows.exe \
            --test-binaries integration-tests/target/release \
            --work-dir "$TEMP/runfiles-stub-tests"
