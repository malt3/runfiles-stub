name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build all artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu,x86_64-unknown-linux-musl,aarch64-unknown-linux-musl,x86_64-pc-windows-gnu

      - name: Install cross-compilation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu musl-tools mingw-w64
          # Create a wrapper for aarch64-linux-gnu-gcc to use as linker
          echo '#!/bin/bash' | sudo tee /usr/local/bin/aarch64-linux-gnu-gcc-wrapper > /dev/null
          echo 'exec aarch64-linux-gnu-gcc "$@"' | sudo tee -a /usr/local/bin/aarch64-linux-gnu-gcc-wrapper > /dev/null
          sudo chmod +x /usr/local/bin/aarch64-linux-gnu-gcc-wrapper

      - name: Setup Cargo config for cross-compilation
        run: |
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << 'EOF'
          [target.aarch64-unknown-linux-gnu]
          linker = "aarch64-linux-gnu-gcc"

          [target.aarch64-unknown-linux-musl]
          linker = "aarch64-linux-gnu-gcc"

          [target.x86_64-pc-windows-gnu]
          linker = "x86_64-w64-mingw32-gcc"
          EOF

      - name: Build template - x86_64 Linux
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu
          cp target/x86_64-unknown-linux-gnu/release/runfiles-stub artifacts/runfiles-stub-x86_64-linux || mkdir -p artifacts && cp target/x86_64-unknown-linux-gnu/release/runfiles-stub artifacts/runfiles-stub-x86_64-linux

      - name: Build template - aarch64 Linux
        run: |
          cargo build --release --target aarch64-unknown-linux-gnu
          mkdir -p artifacts
          cp target/aarch64-unknown-linux-gnu/release/runfiles-stub artifacts/runfiles-stub-aarch64-linux

      - name: Build finalizer - x86_64 Linux (musl)
        working-directory: finalize-stub
        run: |
          # Override parent cargo config
          mkdir -p .cargo
          echo '[target.x86_64-unknown-linux-musl]' > .cargo/config.toml
          echo 'rustflags = ["-C", "target-feature=+crt-static"]' >> .cargo/config.toml
          cargo build --release --target x86_64-unknown-linux-musl
          mkdir -p ../artifacts
          cp target/x86_64-unknown-linux-musl/release/finalize-stub ../artifacts/finalize-stub-x86_64-linux

      - name: Build finalizer - aarch64 Linux (musl)
        working-directory: finalize-stub
        run: |
          cargo build --release --target aarch64-unknown-linux-musl
          cp target/aarch64-unknown-linux-musl/release/finalize-stub ../artifacts/finalize-stub-aarch64-linux

      - name: Build finalizer - x86_64 Windows
        working-directory: finalize-stub
        run: |
          cargo build --release --target x86_64-pc-windows-gnu
          cp target/x86_64-pc-windows-gnu/release/finalize-stub.exe ../artifacts/finalize-stub-x86_64-windows.exe

      - name: List artifacts
        run: |
          ls -lh artifacts/
          file artifacts/*

      - name: Upload Linux/Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-linux-windows
          path: artifacts/
          retention-days: 7

  build-macos:
    name: Build macOS finalizer
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Build finalizer - x86_64 macOS
        working-directory: finalize-stub
        run: |
          mkdir -p artifacts
          cargo build --release --target x86_64-apple-darwin
          cp target/x86_64-apple-darwin/release/finalize-stub artifacts/finalize-stub-x86_64-macos

      - name: Build finalizer - aarch64 macOS (Apple Silicon)
        working-directory: finalize-stub
        run: |
          cargo build --release --target aarch64-apple-darwin
          cp target/aarch64-apple-darwin/release/finalize-stub artifacts/finalize-stub-aarch64-macos

      - name: List artifacts
        working-directory: finalize-stub
        run: |
          ls -lh artifacts/
          file artifacts/*

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-macos
          path: finalize-stub/artifacts/
          retention-days: 7

  merge-artifacts:
    name: Merge all artifacts
    needs: [build, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux/Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries-linux-windows
          path: ./all-binaries

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries-macos
          path: ./all-binaries

      - name: List all binaries
        run: |
          ls -lh all-binaries/
          file all-binaries/* || true

      - name: Upload merged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: all-binaries/
          retention-days: 7

  test-linux:
    name: Test on Linux
    needs: merge-artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: ./binaries

      - name: Make binaries executable
        run: |
          chmod +x binaries/finalize-stub-x86_64-linux
          chmod +x binaries/runfiles-stub-x86_64-linux
          chmod +x binaries/runfiles-stub-aarch64-linux

      - name: Test finalizer on x86_64 template
        run: |
          echo "Testing finalizer with x86_64 template..."
          ./binaries/finalize-stub-x86_64-linux \
            --transform=0 \
            -o test-stub-x86_64 \
            binaries/runfiles-stub-x86_64-linux \
            /bin/echo "Hello from x86_64"
          sha256sum test-stub-x86_64
          echo "SHA256 (x86_64 stub): $(sha256sum test-stub-x86_64 | cut -d' ' -f1)"

      - name: Test finalizer on aarch64 template
        run: |
          echo "Testing finalizer with aarch64 template..."
          ./binaries/finalize-stub-x86_64-linux \
            --transform=0 \
            -o test-stub-aarch64 \
            binaries/runfiles-stub-aarch64-linux \
            /bin/echo "Hello from aarch64"
          sha256sum test-stub-aarch64
          echo "SHA256 (aarch64 stub): $(sha256sum test-stub-aarch64 | cut -d' ' -f1)"

      - name: Run x86_64 template (native)
        run: |
          echo "Running native x86_64 stub..."
          chmod +x test-stub-x86_64
          # Create a test manifest
          mkdir -p /tmp/runfiles
          cp /bin/echo /tmp/runfiles/echo
          export RUNFILES_DIR=/tmp/runfiles
          ./test-stub-x86_64 || echo "Exit code: $?"

      - name: Verify template is actually calling echo
        run: |
          echo "Creating proper manifest..."
          cat > manifest.txt << 'EOF'
          /bin/echo /bin/echo
          EOF
          RUNFILES_MANIFEST_FILE=manifest.txt ./test-stub-x86_64

      - name: Trace syscalls with strace (x86_64)
        run: |
          echo "Running x86_64 stub under strace to validate execve syscall..."
          cat > manifest.txt << 'EOF'
          /bin/echo /bin/echo
          EOF
          strace -f -e trace=execve RUNFILES_MANIFEST_FILE=manifest.txt ./test-stub-x86_64 2>&1 | grep execve || true
          echo ""
          echo "Full strace output for verification:"
          strace -f RUNFILES_MANIFEST_FILE=manifest.txt ./test-stub-x86_64 2>&1 | head -50

  test-macos:
    name: Test on macOS
    needs: merge-artifacts
    runs-on: macos-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: ./binaries

      - name: Detect architecture
        id: arch
        run: |
          ARCH=$(uname -m)
          echo "arch=$ARCH" >> $GITHUB_OUTPUT
          echo "Detected architecture: $ARCH"

      - name: Make binaries executable
        run: |
          if [ "${{ steps.arch.outputs.arch }}" = "arm64" ]; then
            chmod +x binaries/finalize-stub-aarch64-macos
          else
            chmod +x binaries/finalize-stub-x86_64-macos
          fi

      - name: Test finalizer on x86_64 template
        run: |
          if [ "${{ steps.arch.outputs.arch }}" = "arm64" ]; then
            FINALIZER="binaries/finalize-stub-aarch64-macos"
          else
            FINALIZER="binaries/finalize-stub-x86_64-macos"
          fi

          echo "Testing finalizer with x86_64 template..."
          $FINALIZER \
            --transform=0 \
            -o test-stub-x86_64 \
            binaries/runfiles-stub-x86_64-linux \
            /bin/echo "Hello from x86_64"
          shasum -a 256 test-stub-x86_64
          echo "SHA256 (x86_64 stub): $(shasum -a 256 test-stub-x86_64 | cut -d' ' -f1)"

      - name: Test finalizer on aarch64 template
        run: |
          if [ "${{ steps.arch.outputs.arch }}" = "arm64" ]; then
            FINALIZER="binaries/finalize-stub-aarch64-macos"
          else
            FINALIZER="binaries/finalize-stub-x86_64-macos"
          fi

          echo "Testing finalizer with aarch64 template..."
          $FINALIZER \
            --transform=0 \
            -o test-stub-aarch64 \
            binaries/runfiles-stub-aarch64-linux \
            /bin/echo "Hello from aarch64"
          shasum -a 256 test-stub-aarch64
          echo "SHA256 (aarch64 stub): $(shasum -a 256 test-stub-aarch64 | cut -d' ' -f1)"

  test-windows:
    name: Test on Windows
    needs: merge-artifacts
    runs-on: windows-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: ./binaries

      - name: Test finalizer on x86_64 template
        shell: bash
        run: |
          echo "Testing finalizer with x86_64 template..."
          ./binaries/finalize-stub-x86_64-windows.exe \
            --transform=0 \
            -o test-stub-x86_64 \
            binaries/runfiles-stub-x86_64-linux \
            /bin/echo "Hello from x86_64"
          sha256sum test-stub-x86_64 || certutil -hashfile test-stub-x86_64 SHA256

      - name: Test finalizer on aarch64 template
        shell: bash
        run: |
          echo "Testing finalizer with aarch64 template..."
          ./binaries/finalize-stub-x86_64-windows.exe \
            --transform=0 \
            -o test-stub-aarch64 \
            binaries/runfiles-stub-aarch64-linux \
            /bin/echo "Hello from aarch64"
          sha256sum test-stub-aarch64 || certutil -hashfile test-stub-aarch64 SHA256
